<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìÅ –ú–µ–Ω–µ–¥–∂–µ—Ä –∞—Ä—Ö–∏–≤–æ–≤</title>
  <link rel="stylesheet" href="/global.css">
  <style>
    .manager-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    .controls {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 6px;
      border: 1px solid var(--accent);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .controls input, .controls button {
      padding: 8px 12px;
      background: var(--hover-bg);
      border: 1px solid var(--accent);
      color: var(--fg);
      font-family: var(--font-mono);
      border-radius: 4px;
    }

    .controls button {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .controls button:hover {
      background: var(--accent);
      color: var(--bg);
      box-shadow: var(--glow);
    }

    .breadcrumb {
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .breadcrumb a {
      color: var(--accent);
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .item-card {
      background: var(--card-bg);
      border: 1px solid var(--accent);
      border-radius: 6px;
      padding: 10px;
      text-align: center;
      transition: all 0.2s ease;
      position: relative;
    }

    .item-card:hover {
      background: var(--hover-bg);
      transform: translateY(-3px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .item-card.folder {
      color: #ffcc00;
    }

    .item-card.file {
      color: #a0d9a0;
    }

    .item-actions {
      position: absolute;
      top: 4px;
      right: 4px;
      display: flex;
      gap: 4px;
    }

    .item-actions button {
      background: rgba(0, 0, 0, 0.5);
      border: none;
      color: #ff6666;
      cursor: pointer;
      font-size: 0.8rem;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .item-actions button:hover {
      background: #ff6666;
      color: var(--bg);
    }

    .item-preview {
      margin: 8px 0;
      font-size: 1.2rem;
    }

    .item-preview img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 3px;
    }

    .item-name {
      font-size: 0.85rem;
      word-break: break-word;
      margin-top: 5px;
    }

    .item-size {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      opacity: 0.7;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--card-bg);
      border: 2px solid var(--accent);
      border-radius: 6px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 70vh;
      overflow: auto;
      box-shadow: 0 0 20px var(--glow);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-title {
      color: var(--accent);
      font-size: 1.2rem;
    }

    .close {
      color: #ff6666;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
    }

    .modal-body {
      color: var(--fg);
      font-size: 0.9rem;
      margin-bottom: 15px;
    }

    .modal-footer {
      margin-top: 15px;
      text-align: right;
    }

    .btn-action {
      background: var(--card-bg);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 6px;
    }

    .btn-action:hover {
      background: var(--accent);
      color: var(--bg);
    }

    .btn-cancel {
      background: var(--card-bg);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-cancel:hover {
      background: var(--accent);
      color: var(--bg);
    }

    /* –î—Ä–µ–≤–æ–≤–∏–¥–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä –ø–∞–ø–æ–∫ */
    .folder-tree {
      background: var(--hover-bg);
      border: 1px solid var(--accent);
      border-radius: 4px;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 8px;
    }

    .folder-node {
      list-style-type: none;
      padding-left: 20px;
      margin: 0;
    }

    .folder-node ul {
      padding-left: 20px;
    }

    .folder-node-item {
      margin: 2px 0;
    }

    .folder-node-toggle {
      cursor: pointer;
      background: none;
      border: none;
      color: var(--accent);
      padding: 2px;
      font-size: 0.9rem;
    }

    .folder-node-name {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .folder-node-name:hover {
      background: rgba(0, 255, 153, 0.1);
    }

    .folder-node-name.selected {
      background: rgba(0, 255, 153, 0.2);
      color: #00ffaa;
    }

    .folder-node-icon {
      margin-right: 4px;
      font-size: 0.8rem;
    }

    .current-location {
      font-size: 0.9rem;
      color: var(--accent);
      margin-top: 5px;
      font-style: italic;
    }
  </style>
</head>
<body>

  <header class="nav-bar">
    <div class="breadcrumb">
      <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      <a href="/manager/"> / teletext</a>
      <% if (breadcrumb && breadcrumb.length > 0) { %>
        <% breadcrumb.forEach((crumb, i) => { %>
          <% if (i === breadcrumb.length - 1) { %>
            <span> ‚Üí <%= crumb.name %></span>
          <% } else { %>
            <a href="/manager/<%= encodeURIComponent(crumb.path) %>"> ‚Üí <%= crmb.name %></a>
          <% } %>
        <% }) %>
      <% } %>
    </div>

    <h2>üìÅ –ú–µ–Ω–µ–¥–∂–µ—Ä –∞—Ä—Ö–∏–≤–æ–≤</h2>
  </header>

  <div class="manager-container">
    <div class="controls">
      <input type="text" id="folder-name" placeholder="–ò–º—è –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏">
      <button onclick="createFolder()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
      <input type="file" id="file-input" multiple directory webkitdirectory accept=".html,.png,.svg,.txt,.css,.js,.json,.jpg,.jpeg,.gif,.webp" />
      <button onclick="document.getElementById('file-input').click()">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã/–ø–∞–ø–∫–∏</button>
    </div>

    <div id="drop-zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);" ondragleave="dragLeaveHandler(event);">
      <p>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –ø–∞–ø–∫–∏ —Å—é–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</p>
    </div>

    <div id="progress-container">
      <div id="progress-bar"></div>
      <div id="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="items-grid" id="items-list">
      <% if (folders.length === 0 && files.length === 0) { %>
        <div class="empty-state">
          <p>üìÅ –ü–∞–ø–∫–∞ <code>teletext/<%= currentPath ? currentPath + '/' : '' %></code> –ø—É—Å—Ç–∞</p>
          <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã</p>
        </div>
      <% } %>

      <% folders.forEach(folder => { %>
        <div class="item-card folder" data-name="<%= folder.name %>" data-type="folder">
          <div class="item-actions">
            <button title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–∞–ø–∫—É" onclick="openRenameModal('<%= folder.name %>', 'folder')">‚úèÔ∏è</button>
            <button title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø–∞–ø–∫—É" onclick="openMoveModal('<%= folder.name %>', 'folder')">üöö</button>
            <button title="–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É" onclick="deleteItem('<%= folder.name %>', 'folder')">‚úï</button>
          </div>
          <a href="/manager/<%= encodeURIComponent(folder.path) %>" style="display:block; text-decoration:none; color:inherit;">
            <div class="item-preview">üìÅ</div>
            <div class="item-name"><%= folder.name %></div>
            <div class="item-size"><%= folder.isEmpty ? '–ø—É—Å—Ç–∞—è' : '–µ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ' %></div>
          </a>
        </div>
      <% }) %>

      <% files.forEach(file => { %>
        <div class="item-card file" data-name="<%= file.name %>" data-type="file">
          <div class="item-actions">
            <button title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª" onclick="openRenameModal('<%= file.name %>', 'file')">‚úèÔ∏è</button>
            <button title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª" onclick="openMoveModal('<%= file.name %>', 'file')">üöö</button>
            <button title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª" onclick="deleteItem('<%= file.name %>', 'file')">‚úï</button>
          </div>
          <div class="item-preview">
            <% if (file.ext === '.png') { %>
              <img src="<%= file.url %>" style="width:40px;height:40px;object-fit:cover;">
            <% } else { %>
              üìÑ
            <% } %>
          </div>
          <div class="item-name"><%= file.name %></div>
          <div class="item-size"><%= Math.round(file.size / 1024) %> –ö–ë</div>
        </div>
      <% }) %>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è -->
  <div id="rename-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</div>
        <span class="close" onclick="closeModal('rename-modal')">&times;</span>
      </div>
      <div class="modal-body">
        <p>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è <strong id="rename-target-name"></strong>:</p>
        <input type="text" id="new-name-input" placeholder="–ù–æ–≤–æ–µ –∏–º—è" style="width:100%; padding:8px; background:var(--hover-bg); border:1px solid var(--accent); color:var(--fg); border-radius:4px; font-family:var(--font-mono);">
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal('rename-modal')">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-action" onclick="performRename()">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è -->
  <div id="move-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üöö –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</div>
        <span class="close" onclick="closeModal('move-modal')">&times;</span>
      </div>
      <div class="modal-body">
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è <strong id="move-target-name"></strong>:</p>
        <div class="folder-tree" id="folder-tree">
          <!-- –î–µ—Ä–µ–≤–æ –ø–∞–ø–æ–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∑–¥–µ—Å—å -->
        </div>
        <div class="current-location" id="current-location">–í—ã–±—Ä–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞: (–∫–æ—Ä–µ–Ω—å)</div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal('move-modal')">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-action" onclick="performMove()">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <footer>
    <a href="/" class="btn">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </footer>

  <script>
    const currentPath = `<%= currentPath %>`;
    let currentOperationTarget = null;
    let currentOperationType = null;
    let selectedMoveTargetPath = null; // –•—Ä–∞–Ω–∏—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—É—Ç—å –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ä–µ–≤–∞ –ø–∞–ø–æ–∫
    async function loadFolderTree() {
        try {
            const res = await fetch(`/manager/tree-folders/${encodeURIComponent(currentPath)}`);
            if (res.ok) {
                const tree = await res.json();
                const container = document.getElementById('folder-tree');
                container.innerHTML = '';
                const ul = document.createElement('ul');
                ul.className = 'folder-node';
                buildFolderTree(tree, ul);
                container.appendChild(ul);
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ä–µ–≤–∞ –ø–∞–ø–æ–∫');
            }
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–µ—Ä–µ–≤–∞ –ø–∞–ø–æ–∫:', err);
        }
    }

    function buildFolderTree(node, parentElement) {
        node.forEach(folder => {
            const li = document.createElement('li');
            li.className = 'folder-node-item';

            const toggleSpan = document.createElement('span');
            toggleSpan.className = 'folder-node-toggle';
            toggleSpan.innerHTML = folder.children && folder.children.length > 0 ? '‚ñ∂ ' : '‚Ä¢ ';
            toggleSpan.onclick = (e) => {
                e.stopPropagation();
                const ulChild = li.querySelector('ul');
                if (ulChild) {
                    if (ulChild.style.display === 'none') {
                        ulChild.style.display = 'block';
                        toggleSpan.innerHTML = '‚ñº ';
                    } else {
                        ulChild.style.display = 'none';
                        toggleSpan.innerHTML = '‚ñ∂ ';
                    }
                }
            };

            const nameSpan = document.createElement('span');
            nameSpan.className = 'folder-node-name';
            nameSpan.innerHTML = `<span class="folder-node-icon">üìÅ</span>${folder.name}`;
            nameSpan.onclick = () => {
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö
                document.querySelectorAll('.folder-node-name.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π
                nameSpan.classList.add('selected');
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å
                selectedMoveTargetPath = folder.path;
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                document.getElementById('current-location').textContent = `–í—ã–±—Ä–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞: ${folder.path || '(–∫–æ—Ä–µ–Ω—å)'} `;
            };

            li.appendChild(toggleSpan);
            li.appendChild(nameSpan);

            if (folder.children && folder.children.length > 0) {
                const childUl = document.createElement('ul');
                childUl.className = 'folder-node';
                childUl.style.display = 'none'; // –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                buildFolderTree(folder.children, childUl);
                li.appendChild(childUl);
            }

            parentElement.appendChild(li);
        });
    }

    function openRenameModal(name, type) {
        currentOperationTarget = name;
        currentOperationType = type;
        document.getElementById('rename-target-name').textContent = name;
        document.getElementById('new-name-input').value = name;
        document.getElementById('rename-modal').style.display = 'flex';
    }

    function openMoveModal(name, type) {
        currentOperationTarget = name;
        currentOperationType = type;
        document.getElementById('move-target-name').textContent = name;
        selectedMoveTargetPath = null; // –°–±—Ä–æ—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        document.getElementById('current-location').textContent = '–í—ã–±—Ä–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞: (–∫–æ—Ä–µ–Ω—å)';
        loadFolderTree(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ä–µ–≤–æ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
        document.getElementById('move-modal').style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        currentOperationTarget = null;
        currentOperationType = null;
        selectedMoveTargetPath = null;
    }

    async function performRename() {
        const newName = document.getElementById('new-name-input').value.trim();
        if (!newName || !currentOperationTarget || !currentOperationType) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è.');
            return;
        }

        try {
            const res = await fetch('/rename-item/' + encodeURIComponent(currentPath), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ oldName: currentOperationTarget, newName: newName, type: currentOperationType })
            });

            if (res.ok) {
                closeModal('rename-modal');
                location.reload();
            } else {
                const data = await res.json();
                alert(data.error || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è');
            }
        } catch (err) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
    }

    async function performMove() {
        if (!currentOperationTarget || !currentOperationType) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.');
            return;
        }

        // –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –ø–∞–ø–∫–∞, —Ç–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –∫–æ—Ä–µ–Ω—å (currentPath)
        const targetPath = selectedMoveTargetPath !== null ? selectedMoveTargetPath : '';

        try {
            const res = await fetch('/move-item/' + encodeURIComponent(currentPath), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ itemName: currentOperationTarget, targetPath: targetPath, type: currentOperationType })
            });

            if (res.ok) {
                closeModal('move-modal');
                location.reload();
            } else {
                const data = await res.json();
                alert(data.error || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è');
            }
        } catch (err) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
    }

    async function createFolder() {
      const input = document.getElementById('folder-name');
      const name = input.value.trim();
      if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∞–ø–∫–∏');

      try {
        const res = await fetch(`/create-folder/${encodeURIComponent(currentPath)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        const data = await res.json();
        if (data.success) {
          location.reload();
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞');
        }
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    }

    document.getElementById('file-input').onchange = async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      const formData = new FormData();
      files.forEach(f => formData.append('files', f));

      try {
        const res = await fetch(`/upload/${encodeURIComponent(currentPath)}`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.success || data.saved) {
          location.reload();
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        }
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    };

    // Drag & Drop handlers
    function dragOverHandler(ev) {
      ev.preventDefault();
      document.getElementById('drop-zone').classList.add('drag-over');
    }

    function dragLeaveHandler(ev) {
      ev.preventDefault();
      document.getElementById('drop-zone').classList.remove('drag-over');
    }

    function dropHandler(ev) {
      ev.preventDefault();
      document.getElementById('drop-zone').classList.remove('drag-over');

      const items = ev.dataTransfer.items;

      if (items) {
        let hasDirectory = false;
        for (let i = 0; i < items.length; i++) {
          const item = items[i].webkitGetAsEntry();
          if (item && item.isDirectory) {
            hasDirectory = true;
            break;
          }
        }

        if (hasDirectory) {
          alert('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–ø–æ–∫ —á–µ—Ä–µ–∑ drag\'n\'drop –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã/–ø–∞–ø–∫–∏".');
          return;
        }
      }

      const files = Array.from(ev.dataTransfer.files);
      if (files.length === 0) return;

      const formData = new FormData();
      files.forEach(f => formData.append('files', f));

      uploadFiles(formData);
    }

    async function uploadFiles(formData) {
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');

      progressContainer.style.display = 'block';

      let progress = 0;
      const interval = setInterval(() => {
        if (progress < 90) {
          progress += 5;
          progressBar.style.width = progress + '%';
          progressText.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞... ${progress}%`;
        }
      }, 200);

      try {
        const res = await fetch(`/upload/${encodeURIComponent(currentPath)}`, {
          method: 'POST',
          body: formData
        });
        clearInterval(interval);
        const data = await res.json();

        if (data.success || data.saved) {
          progressBar.style.width = '100%';
          progressText.textContent = '‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
          setTimeout(() => {
            location.reload();
          }, 500);
        } else {
          clearInterval(interval);
          progressBar.style.width = '100%';
          progressText.textContent = '‚ùå –û—à–∏–±–∫–∞';
          setTimeout(() => {
            alert(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            progressContainer.style.display = 'none';
          }, 1000);
        }
      } catch (err) {
        clearInterval(interval);
        progressBar.style.width = '100%';
        progressText.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
        setTimeout(() => {
          alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
          progressContainer.style.display = 'none';
        }, 1000);
      }
    }

    async function deleteItem(name, type) {
      const typeName = type === 'folder' ? '–ø–∞–ø–∫—É' : '—Ñ–∞–π–ª';
      const confirmText = type === 'folder'
        ? `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É "${name}" –∏ –≤—Å—ë –µ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`
        : `–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${name}"?`;

      if (!confirm(confirmText)) return;

      try {
        const res = await fetch('/delete-item/' + encodeURIComponent(currentPath), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, type })
        });
        const data = await res.json();
        if (data.success) {
          location.reload();
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞');
        }
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    }
  </script>

</body>
</html>