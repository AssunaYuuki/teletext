<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìÅ –ú–µ–Ω–µ–¥–∂–µ—Ä –∞—Ä—Ö–∏–≤–æ–≤</title>
  <link rel="stylesheet" href="/global.css">
  <style>
    .manager-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    .controls {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 6px;
      border: 1px solid var(--accent);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .controls input, .controls button {
      padding: 8px 12px;
      background: var(--hover-bg);
      border: 1px solid var(--accent);
      color: var(--fg);
      font-family: var(--font-mono);
      border-radius: 4px;
    }

    .controls button {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .controls button:hover {
      background: var(--accent);
      color: var(--bg);
      box-shadow: var(--glow);
    }

    .breadcrumb {
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .breadcrumb a {
      color: var(--accent);
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .item-card {
      background: var(--card-bg);
      border: 1px solid var(--accent);
      border-radius: 6px;
      padding: 10px;
      text-align: center;
      transition: all 0.2s ease;
      position: relative;
    }

    .item-card:hover {
      background: var(--hover-bg);
      transform: translateY(-3px);
      box-shadow: var(--glow);
    }

    .item-card.folder {
      color: #ffcc00;
    }

    .item-card.file {
      color: #a0d9a0;
    }

    .item-actions {
      position: absolute;
      top: 4px;
      right: 4px;
      display: flex;
      gap: 4px;
    }

    .item-actions button {
      background: rgba(0, 0, 0, 0.5);
      border: none;
      color: #ff6666;
      cursor: pointer;
      font-size: 0.8rem;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .item-actions button:hover {
      background: #ff6666;
      color: var(--bg);
    }

    .item-preview {
      margin: 8px 0;
      font-size: 1.2rem;
    }

    .item-name {
      font-size: 0.85rem;
      word-break: break-word;
      margin-top: 5px;
    }

    .item-size {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      opacity: 0.7;
    }

    /* Drag & Drop */
    #drop-zone {
      border: 2px dashed var(--accent);
      border-radius: 6px;
      padding: 40px;
      text-align: center;
      color: var(--accent);
      margin: 20px 0;
      transition: all 0.2s ease;
      background: rgba(14, 20, 16, 0.3);
    }

    #drop-zone.drag-over {
      background: rgba(0, 255, 153, 0.1);
      border-color: #00ffaa;
      transform: scale(1.02);
    }

    #drop-zone p {
      margin: 0;
      font-size: 1rem;
    }

    /* Progress bar */
    #progress-container {
      display: none;
      margin: 10px 0;
      background: var(--hover-bg);
      border-radius: 4px;
      overflow: hidden;
    }

    #progress-bar {
      height: 10px;
      background: var(--accent);
      width: 0%;
      transition: width 0.2s ease;
    }

    #progress-text {
      font-size: 0.8rem;
      color: var(--accent);
      margin-top: 5px;
    }

    /* Uploading animation */
    .uploading-card {
      position: relative;
      opacity: 0.7;
    }

    .uploading-card .item-preview::after {
      content: "üåÄ";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
</head>
<body>

  <header>
    <h1>üìÅ –ú–µ–Ω–µ–¥–∂–µ—Ä –∞—Ä—Ö–∏–≤–æ–≤</h1>
    <div class="breadcrumb">
      <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      <a href="/manager/"> / teletext</a>
      <% if (breadcrumb && breadcrumb.length > 0) { %>
        <% breadcrumb.forEach((crumb, i) => { %>
          <% if (i === breadcrumb.length - 1) { %>
            <span> ‚Üí <%= crumb.name %></span>
          <% } else { %>
            <a href="/manager/<%= encodeURIComponent(crumb.path) %>"> ‚Üí <%= crumb.name %></a>
          <% } %>
        <% }) %>
      <% } %>
    </div>
  </header>

  <div class="manager-container">
    <div class="controls">
      <input type="text" id="folder-name" placeholder="–ò–º—è –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏">
      <button onclick="createFolder()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
      <input type="file" id="file-input" multiple directory webkitdirectory accept=".html,.png,.svg,.txt" />
      <button onclick="document.getElementById('file-input').click()">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã/–ø–∞–ø–∫–∏</button>
    </div>

    <div id="drop-zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);" ondragleave="dragLeaveHandler(event);">
      <p>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –ø–∞–ø–∫–∏ —Å—é–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</p>
    </div>

    <div id="progress-container">
      <div id="progress-bar"></div>
      <div id="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="items-grid" id="items-list">
      <% if (folders.length === 0 && files.length === 0) { %>
        <div class="empty-state">
          <p>üìÅ –ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞</p>
        </div>
      <% } %>

      <% folders.forEach(folder => { %>
        <div class="item-card folder">
          <div class="item-actions">
            <button title="–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É" onclick="deleteItem('<%= folder.name %>', 'folder')">‚úï</button>
          </div>
          <a href="/manager/<%= encodeURIComponent(folder.path) %>" style="display:block; text-decoration:none; color:inherit;">
            <div class="item-preview">üìÇ</div>
            <div class="item-name"><%= folder.name %></div>
            <div class="item-size"><%= folder.isEmpty ? '–ø—É—Å—Ç–∞—è' : '–µ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ' %></div>
          </a>
        </div>
      <% }) %>

      <% files.forEach(file => { %>
        <div class="item-card file">
          <div class="item-actions">
            <button title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª" onclick="deleteItem('<%= file.name %>', 'file')">‚úï</button>
          </div>
          <div class="item-preview">
            <% if (file.ext === '.png') { %>
              <img src="<%= file.url %>" style="width:40px;height:40px;object-fit:cover;">
            <% } else { %>
              üìÑ
            <% } %>
          </div>
          <div class="item-name"><%= file.name %></div>
          <div class="item-size"><%= Math.round(file.size / 1024) %> –ö–ë</div>
        </div>
      <% }) %>
    </div>
  </div>

  <footer>
    <a href="/" class="btn">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </footer>

  <script>
    async function createFolder() {
      const input = document.getElementById('folder-name');
      const name = input.value.trim();
      if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∞–ø–∫–∏');

      try {
        const res = await fetch(`/create-folder/<%= encodeURIComponent(currentPath) %>`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        const data = await res.json();
        if (data.success) {
          location.reload();
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞');
        }
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    }

    document.getElementById('file-input').onchange = async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      const formData = new FormData();
      files.forEach(f => formData.append('files', f));

      await uploadFiles(formData);
    };

    async function uploadFiles(formData) {
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');

      progressContainer.style.display = 'block';

      // –ò–º–∏—Ç–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      let progress = 0;
      const interval = setInterval(() => {
        if (progress < 90) {
          progress += 5;
          progressBar.style.width = progress + '%';
          progressText.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞... ${progress}%`;
        }
      }, 200);

      try {
        const res = await fetch(`/upload/<%= encodeURIComponent(currentPath) %>`, {
          method: 'POST',
          body: formData
        });
        clearInterval(interval);
        const data = await res.json();

        if (data.success || data.saved) {
          progressBar.style.width = '100%';
          progressText.textContent = '‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
          setTimeout(() => {
            location.reload();
          }, 500);
        } else {
          clearInterval(interval);
          progressBar.style.width = '100%';
          progressText.textContent = '‚ùå –û—à–∏–±–∫–∞';
          setTimeout(() => {
            alert(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            progressContainer.style.display = 'none';
          }, 1000);
        }
      } catch (err) {
        clearInterval(interval);
        progressBar.style.width = '100%';
        progressText.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
        setTimeout(() => {
          alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
          progressContainer.style.display = 'none';
        }, 1000);
      }
    }

    // Drag & Drop handlers
    function dragOverHandler(ev) {
      ev.preventDefault();
      document.getElementById('drop-zone').classList.add('drag-over');
    }

    function dragLeaveHandler(ev) {
      ev.preventDefault();
      document.getElementById('drop-zone').classList.remove('drag-over');
    }

    function dropHandler(ev) {
      ev.preventDefault();
      document.getElementById('drop-zone').classList.remove('drag-over');

      const items = ev.dataTransfer.items;

      if (items) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–∞–ø–∫–∏
        let hasDirectory = false;
        for (let i = 0; i < items.length; i++) {
          const item = items[i].webkitGetAsEntry();
          if (item && item.isDirectory) {
            hasDirectory = true;
            break;
          }
        }

        if (hasDirectory) {
          alert('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–ø–æ–∫ —á–µ—Ä–µ–∑ drag\'n\'drop –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã/–ø–∞–ø–∫–∏".');
          return;
        }
      }

      const files = Array.from(ev.dataTransfer.files);
      if (files.length === 0) return;

      const formData = new FormData();
      files.forEach(f => formData.append('files', f));

      uploadFiles(formData);
    }

    async function deleteItem(name, type) {
      const typeName = type === 'folder' ? '–ø–∞–ø–∫—É' : '—Ñ–∞–π–ª';
      const confirmText = type === 'folder'
        ? `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É "${name}" –∏ –≤—Å—ë –µ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`
        : `–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${name}"?`;

      if (!confirm(confirmText)) return;

      try {
        const res = await fetch(`/delete-item/<%= encodeURIComponent(currentPath) %>`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, type })
        });
        const data = await res.json();
        if (data.success) {
          location.reload();
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞');
        }
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }
    }
  </script>

</body>
</html>