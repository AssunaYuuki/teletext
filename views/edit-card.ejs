<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ ‚Äî <%= folderName %></title>
  <link rel="stylesheet" href="/global.css">
  <style>
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font-mono);
      line-height: 1.5;
      padding: 12px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-image: radial-gradient(ellipse at center, #1a2024 0%, #12161a 70%);
    }

    .edit-container {
      max-width: 700px;
      margin: 20px auto;
      padding: 25px;
      background: rgba(14, 20, 16, 0.85);
      border: 1px solid var(--accent);
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 255, 153, 0.2),
                  inset 0 0 10px rgba(0, 60, 30, 0.5);
      position: relative;
      overflow: hidden;
    }

    .edit-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(0, 255, 153, 0.03) 0%, rgba(0, 255, 153, 0.01) 100%);
      pointer-events: none;
    }

    .edit-container > * {
      position: relative;
      z-index: 2;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--accent);
      padding-bottom: 15px;
    }

    h1 {
      font-size: 1.8rem;
      margin: 10px 0;
      color: var(--accent);
      text-shadow: 0 0 8px rgba(0, 255, 153, 0.6);
    }

    .subtitle {
      opacity: 0.7;
      font-size: 1rem;
    }

    .path-display {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      color: var(--accent);
      margin: 10px 0;
      background: rgba(0, 30, 15, 0.4);
      padding: 6px 10px;
      border-radius: 4px;
      display: inline-block;
    }

    .card-preview {
      background: #0a220a;
      border: 2px solid #00ff88;
      border-radius: 6px;
      padding: 18px;
      margin: 20px auto;
      max-width: 320px;
      font-family: var(--font-mono);
      color: #a0d9a0;
      font-size: 0.95rem;
      box-shadow: 0 0 12px rgba(0, 255, 136, 0.3),
                  inset 0 0 10px rgba(0, 60, 30, 0.8);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card-preview:hover {
      transform: scale(1.02);
      box-shadow: 0 0 16px rgba(0, 255, 136, 0.5),
                  inset 0 0 10px rgba(0, 60, 30, 0.8);
    }

    .card-preview img {
      height: 45px;
      max-width: 100%;
      object-fit: contain;
      margin-bottom: 10px;
      border-radius: 4px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .card-preview .card-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: #00ffaa;
      word-break: break-word;
      text-align: center;
    }

    .form-section {
      background: rgba(14, 20, 16, 0.9);
      padding: 20px;
      border-radius: 6px;
      margin: 20px 0;
      border: 1px solid rgba(0, 255, 153, 0.2);
      box-shadow: 0 0 8px rgba(0, 255, 153, 0.1);
    }

    .form-section h2 {
      color: var(--accent);
      margin-top: 0;
      font-size: 1.2rem;
      text-shadow: 0 0 5px rgba(0, 255, 153, 0.4);
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: var(--accent);
      font-weight: bold;
      font-size: 0.95rem;
    }

    .form-group input[type="text"],
    .form-group input[type="file"] {
      width: 100%;
      padding: 10px 14px;
      background: rgba(20, 30, 22, 0.9);
      border: 1px solid var(--accent);
      color: var(--fg);
      font-family: var(--font-mono);
      border-radius: 4px;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }

    .form-group input[type="text"]:focus,
    .form-group input[type="file"]:focus {
      outline: none;
      border-color: #00ffaa;
      box-shadow: 0 0 8px rgba(0, 255, 170, 0.3);
    }

    .form-group input[type="file"] {
      padding: 8px;
    }

    small {
      display: block;
      margin-top: 6px;
      opacity: 0.7;
      font-size: 0.85rem;
    }

    .btn {
      display: inline-block;
      padding: 10px 22px;
      background: rgba(14, 20, 16, 0.9);
      border: 1px solid var(--accent);
      color: var(--accent);
      text-decoration: none;
      font-weight: bold;
      border-radius: 4px;
      margin: 5px;
      transition: all 0.2s ease;
      font-family: var(--font-mono);
      cursor: pointer;
    }

    .btn:hover {
      background: var(--accent);
      color: var(--bg);
      box-shadow: 0 0 10px rgba(0, 255, 153, 0.5);
    }

    .btn-red {
      border-color: #ff6666;
      color: #ff6666;
    }

    .btn-red:hover {
      background: #ff6666;
      color: var(--bg);
      box-shadow: 0 0 10px rgba(255, 102, 102, 0.5);
    }

    .btn-group {
      text-align: center;
      margin: 25px 0;
    }

    .logo-preview {
      margin-top: 10px;
      text-align: center;
    }

    .logo-preview img {
      max-height: 60px;
      max-width: 100%;
      border: 1px solid var(--accent);
      border-radius: 4px;
      display: block;
      margin: 0 auto;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px dashed var(--accent);
      font-size: 0.85rem;
      opacity: 0.6;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .loading::after {
      content: ' ...';
      animation: dot 1s steps(3, end) infinite;
    }

    @keyframes dot {
      0% { content: ' ...'; }
      33% { content: ' .  '; }
      66% { content: '  . '; }
    }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background: rgba(0, 255, 153, 0.2);
      border: 1px solid var(--accent);
      border-radius: 4px;
      color: var(--accent);
      font-family: var(--font-mono);
      z-index: 1000;
      display: none;
    }

    .notification.show {
      display: block;
      animation: fadeInOut 3s ease;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; top: 10px; }
      10% { opacity: 1; top: 20px; }
      90% { opacity: 1; top: 20px; }
      100% { opacity: 0; top: 10px; }
    }
  </style>
</head>
<body class="crt">

  <div class="notification" id="notification">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</div>

  <header>
    <h1>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏</h1>
    <p class="subtitle"><%= folderName %></p>
    <p class="path-display">–ü—É—Ç—å: <code><%= archivePath %></code></p>
  </header>

  <div class="edit-container">
    <!-- –ü—Ä–µ–≤—å—é –∫–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class="card-preview">
      <% if (hasLogo) { %>
        <img id="preview-logo" src="<%= logoUrl %>?t=<%= Date.now() %>" alt="–õ–æ–≥–æ—Ç–∏–ø">
      <% } else { %>
        <div id="preview-logo" style="height:45px; display:flex; align-items:center; justify-content:center; color:#ffcc00; font-size:1.5rem;">üåê</div>
      <% } %>
      <div class="card-title" id="preview-title"><%= currentTitle %></div>
    </div>

    <!-- –§–æ—Ä–º–∞: –ª–æ–≥–æ—Ç–∏–ø + –Ω–∞–∑–≤–∞–Ω–∏–µ -->
    <form id="edit-form" method="POST" action="/save-card/<%= archivePath %>" enctype="multipart/form-data">
      <div class="form-section">
        <h2>üñºÔ∏è –õ–æ–≥–æ—Ç–∏–ø</h2>
        <div class="form-group">
          <label>–¢–µ–∫—É—â–∏–π: <%= hasLogo ? '‚úÖ –ï—Å—Ç—å' : '‚ùå –ù–µ—Ç' %></label>
          <% if (hasLogo) { %>
            <div class="logo-preview">
              <img id="current-logo" src="<%= logoUrl %>?t=<%= Date.now() %>" alt="–õ–æ–≥–æ—Ç–∏–ø">
            </div>
          <% } %>
        </div>

        <div class="form-group">
          <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π (SVG/PNG/JPG)</label>
          <input type="file" name="logo" accept=".svg,.png,.jpg,.jpeg" id="logo-upload">
          <small>–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º ‚Äî –ª–æ–≥–æ—Ç–∏–ø –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è</small>
        </div>
      </div>

      <div class="form-section">
        <h2>üî§ –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</h2>
        <div class="form-group">
          <label for="title">–¢–µ–∫—Å—Ç –ø–æ–¥ –ª–æ–≥–æ—Ç–∏–ø–æ–º</label>
          <input type="text" id="title" name="title" value="<%= currentTitle %>" required maxlength="50" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
          <small>–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ <code>title.txt</code></small>
        </div>
      </div>

      <div class="btn-group">
        <button type="submit" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <a href="#" class="btn" onclick="history.back(); return false;">‚Üê –û—Ç–º–µ–Ω–∞</a>
      </div>
    </form>

    <!-- –£–¥–∞–ª–µ–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–∞ -->
    <% if (hasLogo) { %>
      <div class="form-section" style="border-color: #ff6666; background: rgba(20, 10, 10, 0.8);">
        <h2 style="color: #ff6666;">üóë –£–¥–∞–ª–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</h2>
        <p style="opacity: 0.8; margin: 10px 0;">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        <form method="POST" action="/logo-delete/<%= archivePath %>"
              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø –∏–∑ –ø–∞–ø–∫–∏?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')">
          <button type="submit" class="btn btn-red">üóë –£–¥–∞–ª–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø</button>
        </form>
      </div>
    <% } %>

    <footer>
      <a href="/" class="btn" style="padding:6px 12px;">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </footer>
  </div>

  <script>
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('edit-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(this);
      const submitBtn = this.querySelector('button[type=submit]');
      const originalText = submitBtn.textContent;

      // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      submitBtn.classList.add('loading');
      submitBtn.disabled = true;
      submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ';

      try {
        const response = await fetch(this.action, {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          document.getElementById('notification').classList.add('show');
          setTimeout(() => {
            document.getElementById('notification').classList.remove('show');
          }, 3000);

          // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é
          const newTitle = formData.get('title');
          document.getElementById('preview-title').textContent = newTitle;
          document.getElementById('current-title').textContent = newTitle;

          // –ï—Å–ª–∏ –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω –ª–æ–≥–æ—Ç–∏–ø ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é
          const logoFile = formData.get('logo');
          if (logoFile && logoFile.size > 0) {
            const reader = new FileReader();
            reader.onload = function(e) {
              document.getElementById('preview-logo').src = e.target.result;
              document.getElementById('current-logo').src = e.target.result;
            };
            reader.readAsDataURL(logoFile);
          }
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      } finally {
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ—Ç–∏–ø–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞
    document.getElementById('logo-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('preview-logo').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  </script>

</body>
</html>