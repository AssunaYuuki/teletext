<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ–ª–µ—Ç–µ–∫—Å—Ç</title>
  <link rel="stylesheet" href="/global.css">
</head>
<body>
  <div id="app">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <script src="/js/protect.js"></script>
  <script>
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ fetch
    document.addEventListener('DOMContentLoaded', () => {
        const url = window.location.pathname;
        if (url === '/' || url === '/about') {
            // –ì–ª–∞–≤–Ω–∞—è –∏–ª–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ
            fetch('/api/data')
                .then(r => r.json())
                .then(data => {
                    const app = document.getElementById('app');
                    app.innerHTML = `
                        <header class="nav-bar">
                            <div class="breadcrumb">
                                <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
                            </div>
                            <h2>–¢–µ–ª–µ—Ç–µ–∫—Å—Ç</h2>
                        </header>

                        <div class="folder-container">
                            <div class="content-wrapper">
                                <div class="header">
                                    <h1>–¢–µ–ª–µ—Ç–µ–∫—Å—Ç</h1>
                                    <div class="breadcrumb">
                                        –ü–æ–¥–ø–∞–ø–æ–∫: ${data.folders.length}
                                    </div>
                                </div>

                                <section>
                                    <h3>üìÅ –ê—Ä—Ö–∏–≤—ã</h3>
                                    <div class="grid">
                                        ${data.folders.map(folder => `
                                            <a href="/folder/${folder}" class="card">
                                                <span>${folder}</span>
                                            </a>
                                        `).join('')}
                                    </div>
                                </section>

                                <footer style="margin-top: 30px; text-align: center; font-size: 0.85rem; opacity: 0.7;">
                                    <small>–¢–µ–ª–µ—Ç–µ–∫—Å—Ç | –ü—É—Ç—å: –∫–æ—Ä–µ–Ω—å</small>
                                </footer>
                            </div>
                        </div>
                    `;
                })
                .catch(err => {
                    document.getElementById('app').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
                });
        } else if (url.startsWith('/folder/')) {
            // –ü–∞–ø–∫–∞
            const path = url.replace('/folder/', '');
            fetch('/api/data?path=' + encodeURIComponent(path))
                .then(r => r.json())
                .then(data => {
                    const app = document.getElementById('app');
                    app.innerHTML = `
                        <header class="nav-bar">
                            <div class="breadcrumb">
                                <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
                                ${data.breadcrumb.map(crumb => `<span> ‚Üí ${crumb.name}</span>`).join('')}
                            </div>
                            <h2>${data.folderName}</h2>
                        </header>

                        <div class="folder-container">
                            <div class="content-wrapper">
                                <div class="header">
                                    <h1>${data.folderName}</h1>
                                    <div class="breadcrumb">
                                        –ü–æ–¥–ø–∞–ø–æ–∫: ${data.folders.length}, —Å—Ç—Ä–∞–Ω–∏—Ü: ${data.pages.length}
                                    </div>
                                </div>

                                ${data.folders.length > 0 ? `
                                    <section>
                                        <h3>üìÅ –ü–æ–¥–ø–∞–ø–∫–∏</h3>
                                        <div class="grid">
                                            ${data.folders.map(folder => `
                                                <div class="card-container" style="position:relative; display:inline-block;">
                                                    <div class="card"
                                                         data-logo="${folder.logoUrl || ''}"
                                                         data-folder="${folder.displayName}"
                                                         data-path="${folder.path}"
                                                         onclick="updateHeaderLogo(this); window.location.href='/folder/${folder.path}';"
                                                         onmouseenter="showEditButton(this)"
                                                         onmouseleave="hideEditButton(this)">
                                                        ${folder.logoUrl ? `<img src="${folder.logoUrl}?t=${Date.now()}" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height:32px; max-width: 100%; object-fit: contain; margin-top:8px;">` : `<span style="color:#ffcc00;font-size:1.2rem;">üåê</span>`}
                                                        <span style="font-size:0.85rem; text-align:center; display:block; word-wrap:break-word; line-height:1.2; margin-top:6px;">${folder.displayName}</span>
                                                        ${folder.description ? `<span class="info-icon" onclick="openModal('${folder.displayName}', '${folder.description.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')">‚ÑπÔ∏è</span>` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </section>
                                ` : ''}

                                ${data.pages.length > 0 ? `
                                    <section class="thumbs-grid">
                                        <h3>üñºÔ∏è –°—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
                                        <div class="grid">
                                            ${data.pages.map(page => `
                                                <a href="/page/${data.currentPath}/${page.page}" class="thumb-item">
                                                    ${page.hasThumb ? `<img src="/teletext/${data.currentPath}/${page.page}.png" alt="–°—Ç—Ä. ${page.page}">` : `<div style="height:80px; width:100%; background:#0a220a; display:flex; align-items:center; justify-content:center; color:#00ff88; font-size:1.1rem; font-weight:bold;">${page.page}</div>`}
                                                    <span style="margin-top:4px; font-size:0.85rem;">${page.page}</span>
                                                </a>
                                            `).join('')}
                                        </div>
                                    </section>
                                ` : ''}

                                <footer style="margin-top: 30px; text-align: center; font-size: 0.85rem; opacity: 0.7;">
                                    <small>–¢–µ–ª–µ—Ç–µ–∫—Å—Ç | –ü—É—Ç—å: ${data.currentPath || '–∫–æ—Ä–µ–Ω—å'}</small>
                                </footer>
                            </div>
                        </div>

                        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
                        <div id="modal" class="modal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <div class="modal-title" id="modal-title">–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</div>
                                    <span class="close" onclick="closeModal()">&times;</span>
                                </div>
                                <div class="modal-body" id="modal-body">
                                    <!-- –¢–µ–∫—Å—Ç –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω –∑–¥–µ—Å—å -->
                                </div>
                                <div class="modal-footer">
                                    <button class="btn-close" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .catch(err => {
                    document.getElementById('app').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
                });
        } else if (url.startsWith('/page/')) {
            // –°—Ç—Ä–∞–Ω–∏—Ü–∞
            const parts = url.split('/');
            const path = parts.slice(2, -1).join('/');
            const page = parts[parts.length - 1];
            fetch('/api/data?path=' + encodeURIComponent(path))
                .then(r => r.json())
                .then(data => {
                    const app = document.getElementById('app');
                    app.innerHTML = `
                        <header class="nav-bar">
                            <div class="breadcrumb">
                                <a href="/">üè†</a>
                                ${data.breadcrumb.map(crumb => `<span> ‚Üí ${crumb.name}</span>`).join('')}
                            </div>

                            <h2>
                                <% if (data.hasLogo) { %>
                                    <img id="header-logo" src="<%= data.logoUrl %>?t=<%= Date.now() %>" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height:32px;vertical-align:middle;margin-right:8px;">
                                <% } %>
                                <%= data.folderName %> ‚Äî –°—Ç—Ä. <span id="current-page"><%= page %></span>
                            </h2>

                            <div style="margin-top: 8px;">
                                <button id="prev" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è (‚Üê)" <%= data.prevPage === null ? 'disabled' : '' %>>‚óÑ</button>
                                <input type="number" id="jump" min="100" max="999" value="<%= page %>" size="3">
                                <button id="next" title="–°–ª–µ–¥—É—é—â–∞—è (‚Üí)" <%= data.nextPage === null ? 'disabled' : '' %>>‚ñ∫</button>
                                <a href="/folder/<%= data.currentPath %>" class="btn-list" style="display:inline-block; padding:6px 12px;">üìÅ –°–ø–∏—Å–æ–∫</a>
                            </div>
                        </header>

                        <div class="page-container">
                            <div class="content-wrapper">
                                <div class="teletext-frame">
                                    <%- data.content %>
                                </div>

                                <div class="thumbs-grid">
                                    <h3>üñºÔ∏è –°—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
                                    <div class="grid">
                                        ${data.pageList.map(item => {
                                            return `
                                                <a
                                                  href="/page/${data.currentPath}/${item.page}"
                                                  class="thumb-item <%= item.page === parseInt(page) ? 'active' : '' %>">
                                                  ${item.hasThumb ? `<img src="/teletext/${data.currentPath}/${item.page}.png" alt="–°—Ç—Ä. ${item.page}">` : `<div style="height:100px; background:var(--hover-bg); display:flex; align-items:center; justify-content:center; color:var(--accent); font-size:0.9rem;">${item.page}</div>`}
                                                  <span><%= item.page %></span>
                                                </a>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .catch(err => {
                    document.getElementById('app').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
                });
        } else if (url.startsWith('/edit-card/')) {
            // –†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏
            const path = url.replace('/edit-card/', '');
            fetch('/api/data?path=' + encodeURIComponent(path))
                .then(r => r.json())
                .then(data => {
                    const app = document.getElementById('app');
                    app.innerHTML = `
                        <header class="nav-bar">
                            <div class="breadcrumb">
                                <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
                                ${data.breadcrumb.map(crumb => `<span> ‚Üí ${crumb.name}</span>`).join('')}
                            </div>
                            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${data.folderName}</h2>
                        </header>

                        <div class="content-wrapper">
                            <form action="/save-card/${encodeURIComponent(path)}" method="post" enctype="multipart/form-data">
                                <div>
                                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                                    <input type="text" name="title" value="${data.currentTitle}" required>
                                </div>
                                <div>
                                    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                                    <textarea name="description">${data.currentDescription}</textarea>
                                </div>
                                <div>
                                    <label>–õ–æ–≥–æ—Ç–∏–ø (SVG/PNG):</label>
                                    <input type="file" name="logo">
                                </div>
                                <div>
                                    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                    <a href="/folder/${encodeURIComponent(path)}">–û—Ç–º–µ–Ω–∞</a>
                                </div>
                            </form>
                        </div>
                    `;
                })
                .catch(err => {
                    document.getElementById('app').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
                });
        }
    });

    function updateHeaderLogo(card) {
        const logoUrl = card.getAttribute('data-logo');
        const headerLogo = document.getElementById('header-logo');
        if (headerLogo && logoUrl) {
            headerLogo.style.opacity = '0';
            setTimeout(() => {
                headerLogo.src = logoUrl + '?t=' + Date.now();
                headerLogo.style.opacity = '1';
            }, 100);
        }
    }

    function showEditButton(card) {
        const btn = document.createElement('a');
        btn.className = 'edit-btn-wrapper';
        btn.href = `/edit-card/${card.dataset.path}`;
        btn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É';
        btn.innerHTML = '<span>‚úèÔ∏è</span>';
        btn.addEventListener('click', (e) => e.stopPropagation());
        card.appendChild(btn);
    }

    function hideEditButton(card) {
        const btn = card.querySelector('.edit-btn-wrapper');
        if (btn) card.removeChild(btn);
    }

    function openModal(title, description) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = description;
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('modal');
        if (event.target === modal) closeModal();
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    document.addEventListener('click', e => {
        if (e.target.tagName === 'A' && e.target.getAttribute('href')) {
            e.preventDefault();
            window.history.pushState({}, '', e.target.href);
            window.dispatchEvent(new Event('popstate'));
        }
    });

    window.addEventListener('popstate', () => {
        location.reload();
    });
  </script>
</body>
</html>