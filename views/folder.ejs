<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= folderName %> ‚Äî –°—Ç—Ä–∞–Ω–∏—Ü—ã</title>
  <link rel="stylesheet" href="/global.css">
  <style>
    .folder-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px 0;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font-mono);
    }

    .content-wrapper {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--accent);
      padding-bottom: 10px;
    }

    .header h1 {
      color: var(--accent);
      margin: 0;
      font-size: 2rem;
      text-shadow: 0 0 8px rgba(0, 204, 102, 0.6);
    }

    .breadcrumb {
      font-size: 0.9rem;
      opacity: 0.7;
      margin-top: 5px;
    }

    .breadcrumb a {
      color: var(--accent);
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .card {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 12px;
      background: var(--card-bg);
      border: 1px solid var(--accent);
      border-radius: 6px;
      text-decoration: none;
      color: var(--fg);
      transition: all 0.2s ease;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 255, 136, 0.2);
      border-color: #00ffaa;
    }

    .edit-btn-wrapper {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 15px;
      height: 16px;
      padding: 2px;
      background: transparent;
      border: none;
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s;
      box-shadow: none;
      outline: none;
      text-decoration: none;
      pointer-events: auto;
    }

    .edit-btn-wrapper span {
      font-size: 0.7rem;
      color: #ff6600;
      font-weight: bold;
      margin: 0;
      padding: 0;
      line-height: 1;
      text-decoration: none;
    }

    .thumbs-grid {
      margin-top: 30px;
    }

    .thumbs-grid .grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }

    .thumb-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px;
      border: 1px solid var(--accent);
      border-radius: 4px;
      text-decoration: none;
      color: var(--fg);
    }

    .thumb-item img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 3px;
    }

    /* –ó–Ω–∞—á–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
    .info-icon {
      position: absolute;
      top: 4px;
      left: 4px;
      font-size: 0.7rem;
      color: #00ffaa;
      opacity: 0.7;
      transition: opacity 0.2s ease;
      cursor: pointer;
      z-index: 10;
    }

    .card:hover .info-icon {
      opacity: 1;
    }

    /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∫ –∑–Ω–∞—á–∫—É */
    .tooltip {
      position: absolute;
      top: 20px;
      left: 0;
      white-space: nowrap;
      font-size: 0.7rem;
      color: var(--accent);
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
      z-index: 11;
    }

    .info-icon:hover + .tooltip,
    .info-icon:focus + .tooltip {
      opacity: 1;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--card-bg);
      border: 2px solid var(--accent);
      border-radius: 6px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 70vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 20px rgba(0, 255, 153, 0.5);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-title {
      color: var(--accent);
      font-size: 1.2rem;
      text-shadow: 0 0 5px rgba(0, 255, 153, 0.4);
    }

    .close {
      color: #ff6666;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .close:hover {
      text-shadow: 0 0 5px #ff6666;
    }

    .modal-body {
      color: var(--fg);
      font-size: 0.9rem;
      white-space: pre-line;
      line-height: 1.4;
    }

    .modal-footer {
      margin-top: 15px;
      text-align: right;
    }

    .btn-close {
      background: var(--card-bg);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-close:hover {
      background: var(--accent);
      color: var(--bg);
    }

    /* –°–µ–∫—Ü–∏–∏ –ø–æ –≥–æ–¥–∞–º */
    .year-section {
      margin-bottom: 30px;
    }

    .year-header {
      color: var(--accent);
      font-size: 1.3rem;
      margin: 20px 0 10px 0;
      text-align: center;
      text-shadow: 0 0 5px rgba(0, 255, 153, 0.4);
      border-bottom: 1px dashed var(--accent);
      padding-bottom: 5px;
    }

    .year-folders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .year-folder-item {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 12px;
      background: var(--card-bg);
      border: 1px solid var(--accent);
      border-radius: 6px;
      text-decoration: none;
      color: var(--fg);
      transition: all 0.2s ease;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }

    .year-folder-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 255, 136, 0.2);
      border-color: #00ffaa;
    }

    .year-folder-item img {
      height: 32px;
      max-width: 100%;
      object-fit: contain;
      margin-top: 8px;
    }

    .year-folder-item span {
      display: block;
      text-align: center;
      color: var(--accent);
      font-size: 0.85rem;
      word-wrap: break-word;
      line-height: 1.2;
      margin-top: 6px;
    }

    .year-edit-btn-wrapper {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 15px;
      height: 16px;
      padding: 2px;
      background: transparent;
      border: none;
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s;
      box-shadow: none;
      outline: none;
      text-decoration: none;
      pointer-events: auto;
    }

    .year-edit-btn-wrapper span {
      font-size: 0.7rem;
      color: #ff6600;
      font-weight: bold;
      margin: 0;
      padding: 0;
      line-height: 1;
      text-decoration: none;
    }

    .year-info-icon {
      position: absolute;
      top: 4px;
      left: 4px;
      font-size: 0.7rem;
      color: #00ffaa;
      opacity: 0.7;
      transition: opacity 0.2s ease;
      cursor: pointer;
      z-index: 10;
    }

    .year-folder-item:hover .year-info-icon {
      opacity: 1;
    }

    .year-tooltip {
      position: absolute;
      top: 20px;
      left: 0;
      white-space: nowrap;
      font-size: 0.7rem;
      color: var(--accent);
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
      z-index: 11;
    }

    .year-info-icon:hover + .year-tooltip,
    .year-info-icon:focus + .year-tooltip {
      opacity: 1;
    }
  </style>
</head>
<body>

  <header class="nav-bar">
    <div class="breadcrumb">
      <a href="/">üè†</a>
      <% if (breadcrumb && breadcrumb.length > 0) { %>
        <% breadcrumb.forEach((crumb, i) => { %>
          <% if (i === breadcrumb.length - 1) { %>
            <span> ‚Üí <%= crumb.name %></span>
          <% } else { %>
            <a href="/folder/<%= encodeURIComponent(crumb.path) %>"> ‚Üí <%= crumb.name %></a>
          <% } %>
        <% }) %>
      <% } %>
    </div>

    <h2>
      <% if (hasLogo) { %>
        <img id="header-logo" src="<%= logoUrl %>?t=<%= Date.now() %>" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height:32px;vertical-align:middle;margin-right:8px;">
      <% } %>
      <%= folderName %>
    </h2>
  </header>

  <div class="folder-container">
    <div class="content-wrapper">
      <div class="header">
        <h1><%= folderName %></h1>
        <div class="breadcrumb">
          –ü–æ–¥–ø–∞–ø–æ–∫: <%= folders.length %>, —Å—Ç—Ä–∞–Ω–∏—Ü: <%= pages.length %>
        </div>
      </div>

      <% if (groupedFolders && Object.keys(groupedFolders).length > 0) { %>
        <section>
          <h3>üìÅ –ü–æ–¥–ø–∞–ø–∫–∏</h3>
          <% Object.entries(groupedFolders).forEach(([year, foldersInYear]) => { %>
            <div class="year-section">
              <% if (year !== '0') { %>
                <h4 class="year-header"><%= year %></h4>
              <% } else { %>
                <h4 class="year-header">–ë–µ–∑ –≥–æ–¥–∞</h4>
              <% } %>
              <div class="year-folders-grid">
                <% foldersInYear.forEach(folder => {
                    const card = folderCards[folder] || {};
                    const logoUrl = card.logoUrl;
                    const displayName = card.displayName || folder;
                    const description = card.description || '';
                %>
                  <div class="card-container" style="position:relative; display:inline-block;">
                    <div class="year-folder-item"
                         data-logo="<%= logoUrl || '' %>"
                         data-folder="<%= folder %>"
                         data-path="<%= currentPath ? currentPath + '/' + folder : folder %>"
                         onclick="updateHeaderLogo(this); window.location.href='/folder/<%= encodeURIComponent(currentPath ? currentPath + '/' + folder : folder) %>';"
                         onmouseenter="showEditButton(this)"
                         onmouseleave="hideEditButton(this)"
                         >

                      <% if (logoUrl) { %>
                        <img src="<%= logoUrl %>?t=<%= Date.now() %>" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height:32px; max-width: 100%; object-fit: contain; margin-top:8px;">
                      <% } else { %>
                        <span style="color:#ffcc00;font-size:1.2rem;">üåê</span>
                      <% } %>

                      <span style="font-size:0.85rem; text-align:center; display:block; word-wrap:break-word; line-height:1.2; margin-top:6px;"><%= displayName %></span>

                      <% if (description && description.trim()) { %>
                        <span class="year-info-icon" onclick="openModal('<%= displayName.replace(/'/g, "\\'") %>', '<%= description.replace(/'/g, "\\'").replace(/\n/g, "\\n") %>'); event.stopPropagation();">‚ÑπÔ∏è</span>
                        <span class="year-tooltip">–û–ø–∏—Å–∞–Ω–∏–µ</span>
                      <% } %>

                    </div>
                  </div>
                <% }) %>
              </div>
            </div>
          <% }) %>
        </section>
      <% } else if (folders.length > 0) { %>
        <!-- ‚úÖ –ï—Å–ª–∏ –Ω–µ—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
        <section>
          <h3>üìÅ –ü–æ–¥–ø–∞–ø–∫–∏</h3>
          <div class="grid">
            <% folders.forEach(folder => {
                const card = folderCards[folder] || {};
                const logoUrl = card.logoUrl;
                const displayName = card.displayName || folder;
                const description = card.description || '';
            %>
              <div class="card-container" style="position:relative; display:inline-block;">
                <div class="card"
                     data-logo="<%= logoUrl || '' %>"
                     data-folder="<%= folder %>"
                     data-path="<%= currentPath ? currentPath + '/' + folder : folder %>"
                     onclick="updateHeaderLogo(this); window.location.href='/folder/<%= encodeURIComponent(currentPath ? currentPath + '/' + folder : folder) %>';"
                     onmouseenter="showEditButton(this)"
                     onmouseleave="hideEditButton(this)"
                     >

                  <% if (logoUrl) { %>
                    <img src="<%= logoUrl %>?t=<%= Date.now() %>" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height:32px; max-width: 100%; object-fit: contain; margin-top:8px;">
                  <% } else { %>
                    <span style="color:#ffcc00;font-size:1.2rem;">üåê</span>
                  <% } %>

                  <span style="font-size:0.85rem; text-align:center; display:block; word-wrap:break-word; line-height:1.2; margin-top:6px;"><%= displayName %></span>

                  <% if (description && description.trim()) { %>
                    <span class="info-icon" onclick="openModal('<%= displayName.replace(/'/g, "\\'") %>', '<%= description.replace(/'/g, "\\'").replace(/\n/g, "\\n") %>'); event.stopPropagation();">‚ÑπÔ∏è</span>
                    <span class="tooltip">–û–ø–∏—Å–∞–Ω–∏–µ</span>
                  <% } %>

                </div>
              </div>
            <% }) %>
          </div>
        </section>
      <% } %>

      <!-- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü—ã -->
      <% if (pages.length > 0) { %>
        <section class="thumbs-grid">
          <h3>üñºÔ∏è –°—Ç—Ä–∞–Ω–∏—Ü—ã</h3>
          <div class="grid">
            <% pages.forEach(item => { %>
              <a href="/page/<%= encodeURIComponent(currentPath) %>/<%= item.page %>" class="thumb-item">
                <% if (item.hasThumb) { %>
                                            <img src="<%= `/teletext/${currentPath}/${item.page}.png` %>?t=<%= Date.now() %>" alt="–°—Ç—Ä. <%= item.page %>" onerror="this.src='https://tele.assunayuuki.ru/teletext/images/no-preview.png'; this.alt='–ù–µ—Ç –ø—Ä–µ–≤—å—é';">
                <% } else { %>
                  <div style="height:80px; width:100%; background:#0a220a; display:flex; align-items:center; justify-content:center; color:#00ff88; font-size:1.1rem; font-weight:bold;">
                    <%= item.page %>
                  </div>
                <% } %>
                <span style="margin-top:4px; font-size:0.85rem;"><%= item.page %></span>
              </a>
            <% }) %>
          </div>
        </section>
      <% } else if (folders.length === 0) { %>
        <div class="empty" style="text-align:center; margin-top:40px;">
          <p>–ù–µ—Ç –Ω–∏ –ø–æ–¥–ø–∞–ø–æ–∫, –Ω–∏ —Å—Ç—Ä–∞–Ω–∏—Ü.</p>
        </div>
      <% } %>

      <footer style="margin-top: 30px; text-align: center; font-size: 0.85rem; opacity: 0.7;">
        <a href="https://notepad-plus-plus.org/  "><img src="https://tele.assunayuuki.ru/button_npp.png  " alt="Notepad++" /></a>
        <a href="https://galagen.net/  "><img src="https://tele.assunayuuki.ru/touhou.jpg  " alt="Touhou" /></a>
        <a href="https://en.wikipedia.org/wiki/Popotan  "><img src="https://tele.assunayuuki.ru/caramelldansen.gif  " alt="Caramelldansen" /></a>
        <a href="https://archive.org/  "><img src="https://tele.assunayuuki.ru/archive.gif  " alt="Archive" /></a>
        <a href="#"><img src="https://tele.assunayuuki.ru/ie.gif  " alt="IE" /></a>
        <a href="#"><img src="https://tele.assunayuuki.ru/built_with_amiga02.gif  " alt="Amiga" /></a>
        <a href="#"><img src="https://tele.assunayuuki.ru/c64ik.gif  " alt="C64" /></a>
        <a href="#"><img src="https://tele.assunayuuki.ru/css3.gif  " alt="—Åss" /></a>
      </footer>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</div>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer">
        <button class="btn-close" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    function updateHeaderLogo(card) {
      const logoUrl = card.getAttribute('data-logo');
      const headerLogo = document.getElementById('header-logo');
      if (headerLogo && logoUrl) {
        headerLogo.style.opacity = '0';
        setTimeout(() => {
          headerLogo.src = logoUrl + '?t=' + Date.now();
          headerLogo.style.opacity = '1';
        }, 100);
      }
    }

    function showEditButton(card) {
      const btn = document.createElement('a');
      btn.className = 'edit-btn-wrapper';
      btn.href = `/edit-card/${card.dataset.path}`;
      btn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É';
      btn.innerHTML = '<span>‚úèÔ∏è</span>';
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      card.appendChild(btn);
    }

    function hideEditButton(card) {
      const btn = card.querySelector('.edit-btn-wrapper');
      if (btn) {
        card.removeChild(btn);
      }
    }

    function openModal(title, description) {
      document.getElementById('modal-title').textContent = title.replace(/&nbsp;/g, ' ');
      document.getElementById('modal-body').textContent = description.replace(/\\n/g, '\n');
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('modal');
      if (event.target === modal) {
        closeModal();
      }
    }
  </script>

</body>
</html>